sequenceDiagram
autonumber
actor Buyer as 구매자 (Client)
participant Ctrl as AuctionController
participant Svc as AuctionService
participant Repo as AuctionRepository
participant RDB as RDB (Database)
participant Noti as NotificationService (WS)

    Buyer->>Ctrl: POST /api/v1/auctions/{id}/bid (입찰 요청)
    Ctrl->>Svc: processBid(buyerId, auctionId, bidAmount)

    rect rgb(235, 245, 255)
        Note over Svc, RDB: [트랜잭션 시작 & 동시성 제어]
        Svc->>Repo: findByIdWithLock(auctionId)
        Repo->>RDB: SELECT * FROM auctions WHERE id = ? FOR UPDATE
        RDB-->>Svc: Auction Entity 반환 (Lock 획득)
    end

    rect rgb(255, 240, 240)
        Note over Svc: [비즈니스 로직 검증 및 가공]
        Svc->>Svc: 1. 경매 종료 여부 확인
        Svc->>Svc: 2. 연장 구간 여부 체크 (종료 5분 전 여부)
        
        alt 연장 구간인 경우 (Extension Case)
            Svc->>Svc: 종료 시간 5분 추가 & 연장 횟수 갱신
            Svc->>Svc: 입찰가 검증 (연장 3회당 50% 할증 단위 적용)
        else 정상 구간인 경우 (Normal Case)
            Svc->>Svc: 입찰가 검증 (현재가 + 기본 입찰 단위)
        end
    end

    rect rgb(240, 255, 240)
        Note over Svc, RDB: [데이터베이스 업데이트 - 원자적 처리]
        Svc->>RDB: 1. Auction 테이블 업데이트 (현재가, 입찰수, 종료시간 등)
        Svc->>RDB: 2. Bid 테이블 Insert (입찰 이력 기록)
    end
    
    Note over RDB: 트랜잭션 커밋 (Lock 해제)
    RDB-->>Svc: Success

    par 실시간 알림 (Async)
        Svc->>Noti: 입찰 현황 정보 전달
        Noti-->>Buyer: 웹소켓 브로드캐스트 (현재가 갱신 알림)
    end

    Svc-->>Ctrl: BidResponseDto
    Ctrl-->>Buyer: 200 OK (입찰 성공)