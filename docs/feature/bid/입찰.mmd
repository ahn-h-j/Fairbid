sequenceDiagram
autonumber
actor Buyer as 구매자 (Client)
participant Ctrl as BidController
participant UC as PlaceBidUseCase
participant Svc as BidService
participant Cache as RedisBidCacheAdapter
participant Redis as Redis
participant Lua as bid.lua (Lua Script)
participant Domain as Bid (Domain)
participant BidPort as BidRepository (Port)
participant AucPort as AuctionRepository (Port)
participant RDB as MySQL
participant WS as WebSocket

    Buyer->>Ctrl: POST /api/v1/auctions/{id}/bids
    Note right of Buyer: { bidType: "ONE_TOUCH" | "DIRECT" | "INSTANT_BUY",<br/>  amount: 15000 (DIRECT일 때만) }
    Ctrl->>UC: placeBid(PlaceBidCommand)
    UC->>Svc: placeBid(command)

    rect rgb(235, 245, 255)
        Note over Svc, Redis: [1단계: Redis 캐시 확인]
        Svc->>Cache: existsInCache(auctionId)
        Cache->>Redis: EXISTS auction:{id}

        alt 캐시 미스
            Redis-->>Cache: false
            Svc->>Svc: loadAuctionToRedis(auctionId)
            Note right of Svc: RDB에서 조회 후<br/>Redis에 로드
        end
    end

    rect rgb(255, 240, 240)
        Note over Svc, Lua: [2단계: Lua 스크립트 원자적 입찰]
        Svc->>Cache: placeBidAtomic(auctionId, bidderId, bidType, amount)
        Cache->>Redis: EVALSHA bid.lua

        Redis->>Lua: 실행
        Note over Lua: [검증]<br/>1. 경매 상태 확인 (ACTIVE/INSTANT_BUY_PENDING)<br/>2. 종료 시간 확인<br/>3. 본인 경매 입찰 불가<br/>4. 최고 입찰자 재입찰 불가

        Lua->>Lua: [BidType별 금액 계산]
        Note right of Lua: ONE_TOUCH: currentPrice + bidIncrement<br/>DIRECT: 요청 금액 (최소금액 검증)<br/>INSTANT_BUY: instantBuyPrice

        Lua->>Lua: [경매 연장 확인]
        Note right of Lua: 종료 5분 전 입찰 시<br/>→ endTime += 5분<br/>→ extensionCount++<br/>→ 3회마다 입찰단위 50% 증가

        Lua->>Lua: [상태 업데이트]
        Note right of Lua: currentPrice = newBidAmount<br/>highestBidderId = bidderId<br/>totalBidCount++<br/>bidIncrement 재계산

        Lua-->>Redis: BidResult
        Redis-->>Cache: BidResult
        Cache-->>Svc: BidResult
    end

    rect rgb(240, 255, 240)
        Note over Svc, RDB: [3단계: RDB 동기화]
        Svc->>Domain: Bid.create(auctionId, bidderId, amount, bidType)

        par 병렬 처리
            Svc->>BidPort: save(bid)
            BidPort->>RDB: INSERT INTO bids (...)
        and
            Svc->>AucPort: updateCurrentPrice(auctionId, newPrice)
            AucPort->>RDB: UPDATE auctions SET current_price = ?
        end
    end

    rect rgb(255, 250, 230)
        Note over Svc, WS: [4단계: 실시간 알림]
        Svc->>WS: publish(BidPlacedEvent)
        WS-->>Buyer: WebSocket 브로드캐스트
        Note right of WS: 경매 참여자들에게<br/>실시간 입찰 현황 전송
    end

    Svc-->>UC: BidResponse
    UC-->>Ctrl: BidResponse
    Ctrl-->>Buyer: 200 OK
