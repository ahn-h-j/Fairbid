sequenceDiagram
autonumber
participant Sched as Bid (Scheduler)
participant RDB as RDB (Database)
participant Noti as NotificationService (WS)
participant Buyer as 구매자 (Client)

    Note over Sched: 1. 스케줄러 매초 동작 (Polling)

    rect rgb(235, 245, 255)
        Note over Sched, RDB: [1단계: 즉시 차단]
        Sched->>RDB: 2. 종료 대상 조회 (status='ACTIVE')
        RDB-->>Sched: 3. 종료 대상 리스트 반환
        
        Sched->>Noti: 4. 경매 종료 알림 요청 (BroadCast)
        Noti-->>Buyer: 5. 웹소켓 종료 신호 전달 (UI 즉시 차단)
    end

    rect rgb(255, 240, 240)
        Note over Sched, RDB: [2단계: 1, 2순위 추출]
        Sched->>RDB: 6. 최고가/차순위 입찰자 조회 (ORDER BY DESC LIMIT 2)
        RDB-->>Sched: 7. 입찰자 데이터 반환
    end

    rect rgb(240, 255, 240)
        Note over Sched, RDB: [3단계: Outbox 패턴 기반 트랜잭션 (8~10)]
        Note over Sched, RDB: [Transaction 시작]
        Sched->>RDB: 8. Auction 상태 변경 (CLOSED) 및 1순위 낙찰자 기록
        Sched->>RDB: 9. Winning 테이블에 1, 2순위 후보 정보 저장
        Sched->>RDB: 10. Outbox 테이블에 알림 및 결제 감시 이벤트 저장
        Note over RDB: [Transaction 커밋]

        par 비동기 실행 (Relay)
            Sched->>Noti: 11. 1순위 낙찰자 개별 통보
            Sched->>Sched: 12. 결제 만료 시간(Timeout) 감시 시작
        end
    end

    %% 승계 처리 구간
    opt [조건부] 1순위 미결제 시 (2순위 승계 로직)
        rect rgb(255, 240, 240)
            Note over Sched, RDB: [4단계: 노쇼 처리 및 정보 동기화]
            Sched->>RDB: 13. 1순위 유저 패널티 부여 (User Table)
            
            Note over Sched, RDB: [승계 트랜잭션 시작]
            Sched->>RDB: 14. Winning 테이블: 2순위로 낙찰 권한 승계 업데이트
            Sched->>RDB: 15. Auction 테이블: 최종 낙찰자(buyer_id)를 2순위로 변경
            Note over RDB: [승계 트랜잭션 커밋]
        end
        
        Sched->>Noti: 16. 2순위 승계 알림 및 결제 요청 발송
    end