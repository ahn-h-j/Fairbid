sequenceDiagram
autonumber
actor Seller as 판매자 (Client)
participant Ctrl as AuctionController
participant UC as CreateAuctionUseCase
participant Svc as AuctionService
participant Domain as Auction (Domain)
participant Policy as BidIncrementPolicy
participant Port as AuctionRepository (Port)
participant Adapter as AuctionPersistenceAdapter
participant Cache as RedisAuctionCacheAdapter
participant RDB as MySQL
participant Redis as Redis

    Seller->>Ctrl: POST /api/v1/auctions (CreateAuctionRequest)
    Ctrl->>UC: createAuction(CreateAuctionCommand)
    UC->>Svc: createAuction(command)

    rect rgb(235, 245, 255)
        Note over Svc, Domain: [도메인 생성 및 검증]
        Svc->>Domain: Auction.create(command)
        Note right of Domain: 1. 즉시구매가 > 시작가 검증<br/>2. 거래 방식 최소 1개 검증<br/>3. 직거래 시 위치 필수 검증

        Domain->>Policy: calculateBaseIncrement(startPrice)
        Note right of Policy: [가격 구간별 입찰 단위]<br/>~1만: 500원<br/>1만~5만: 1,000원<br/>5만~10만: 3,000원<br/>10만~50만: 5,000원<br/>50만~100만: 10,000원<br/>100만~: 30,000원
        Policy-->>Domain: bidIncrement

        Domain->>Domain: endTime 계산 (24h/48h)
        Domain->>Domain: status = ACTIVE
    end

    rect rgb(240, 255, 240)
        Note over Svc, RDB: [RDB 저장]
        Svc->>Port: save(auction)
        Port->>Adapter: save(auction)
        Adapter->>RDB: INSERT INTO auctions (...)
        Note right of RDB: seller_id, title, description<br/>start_price, instant_buy_price<br/>current_price, bid_increment<br/>start_at, end_at, status
        RDB-->>Adapter: AuctionEntity
        Adapter-->>Port: Auction
        Port-->>Svc: Auction
    end

    rect rgb(255, 250, 230)
        Note over Svc, Redis: [이벤트 발행 → Redis 캐시]
        Svc->>Svc: eventPublisher.publish(AuctionCreatedEvent)
        Svc->>Cache: saveToCache(auction)
        Cache->>Redis: HSET auction:{id} fields...
        Note right of Redis: Redis Hash 구조<br/>- currentPrice<br/>- bidIncrement<br/>- endTime<br/>- status
        Cache->>Redis: ZADD auction:closing {endTime} {id}
        Note right of Redis: Sorted Set으로<br/>종료 대기 큐 관리
    end

    Svc-->>UC: Auction
    UC-->>Ctrl: CreateAuctionResponse
    Ctrl-->>Seller: 201 Created
