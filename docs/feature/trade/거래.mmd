sequenceDiagram
autonumber
actor Winner as 낙찰자 (구매자)
actor Seller as 판매자
participant Ctrl as TradeController
participant QrySvc as TradeQueryService
participant CmdSvc as TradeCommandService
participant TradeRepo as TradeRepository
participant RDB as MySQL
participant Noti as NotificationPort

    Note over Winner, Noti: [거래 상태 흐름]<br/>AWAITING_METHOD_SELECTION → AWAITING_ARRANGEMENT → ARRANGED → COMPLETED

    %% 거래 정보 조회
    rect rgb(235, 245, 255)
        Note over Winner, RDB: [1단계: 거래 정보 조회]
        Winner->>Ctrl: GET /api/v1/trades/{tradeId}
        Ctrl->>QrySvc: getById(tradeId)
        QrySvc->>TradeRepo: findById(tradeId)
        TradeRepo->>RDB: SELECT * FROM trades WHERE id = ?
        RDB-->>TradeRepo: Trade
        TradeRepo-->>QrySvc: Trade

        QrySvc-->>Ctrl: Trade
        Note right of Ctrl: [응답 데이터]<br/>- 경매 정보 (제목, 이미지)<br/>- 최종 낙찰가<br/>- 판매자 정보<br/>- 거래 방식 옵션<br/>- 현재 거래 상태<br/>- 직거래/배송 상세 정보
        Ctrl-->>Winner: 200 OK (TradeDetailResponse)
    end

    %% 거래 방식 선택
    rect rgb(255, 240, 240)
        Note over Winner, RDB: [2단계: 거래 방식 선택 (24시간 내)]
        Note right of Winner: 경매 설정에 따라 분기:<br/>- 둘 다 가능 → 구매자 선택<br/>- 하나만 가능 → 자동 설정

        Winner->>Ctrl: POST /api/v1/trades/{tradeId}/method
        Note right of Winner: { method: "DIRECT_TRADE" | "DELIVERY" }

        Ctrl->>CmdSvc: selectMethod(tradeId, userId, method)

        CmdSvc->>TradeRepo: findById(tradeId)
        TradeRepo->>RDB: SELECT * FROM trades
        RDB-->>CmdSvc: Trade

        CmdSvc->>CmdSvc: 검증
        Note right of CmdSvc: 1. 구매자 권한 확인<br/>2. 상태가 AWAITING_METHOD_SELECTION인지<br/>3. 경매에서 허용된 방식인지

        alt 직거래 선택 (DIRECT_TRADE)
            CmdSvc->>RDB: INSERT INTO direct_trade_infos (...)
            Note right of RDB: status = PENDING<br/>meetingLocation = 경매 설정값
            CmdSvc->>TradeRepo: updateMethod(DIRECT_TRADE)
            TradeRepo->>RDB: UPDATE trades<br/>SET trade_method = 'DIRECT_TRADE',<br/>status = 'AWAITING_ARRANGEMENT'
        else 택배 선택 (DELIVERY)
            CmdSvc->>RDB: INSERT INTO delivery_infos (...)
            Note right of RDB: status = PENDING
            CmdSvc->>TradeRepo: updateMethod(DELIVERY)
            TradeRepo->>RDB: UPDATE trades<br/>SET trade_method = 'DELIVERY',<br/>status = 'AWAITING_ARRANGEMENT'
        end

        CmdSvc->>Noti: notify(sellerId, METHOD_SELECTED)
        Noti-->>Seller: "구매자가 거래 방식을<br/>선택했습니다."

        CmdSvc-->>Ctrl: Trade
        Ctrl-->>Winner: 200 OK (TradeResponse)
    end

    %% 거래 조율
    rect rgb(240, 255, 240)
        Note over Winner, RDB: [3단계: 거래 조율]

        alt 직거래
            Note over Seller, Winner: 직거래 조율 (별도 문서 참조: 직거래.mmd)
            Note right of Seller: POST /direct/propose → 시간 제안<br/>POST /direct/accept → 수락<br/>POST /direct/counter → 역제안
        else 택배
            Note over Seller, Winner: 배송 처리 (별도 문서 참조: 배송.mmd)
            Note right of Winner: POST /delivery/address → 배송지 입력<br/>POST /delivery/ship → 송장 입력<br/>POST /delivery/confirm → 수령 확인
        end
    end

    %% 거래 완료
    rect rgb(255, 250, 230)
        Note over Winner, RDB: [4단계: 거래 완료]

        Winner->>Ctrl: POST /api/v1/trades/{tradeId}/complete
        Ctrl->>CmdSvc: complete(tradeId, userId)

        CmdSvc->>CmdSvc: 검증
        Note right of CmdSvc: 거래 참여자 권한 확인<br/>거래 상태가 ARRANGED인지 확인

        CmdSvc->>TradeRepo: complete(tradeId)
        TradeRepo->>RDB: UPDATE trades<br/>SET status = 'COMPLETED',<br/>completed_at = NOW()

        CmdSvc->>Noti: notify(TRADE_COMPLETED)
        Noti-->>Seller: "거래가 완료되었습니다."
        Noti-->>Winner: "거래가 완료되었습니다."

        CmdSvc-->>Ctrl: Trade
        Ctrl-->>Winner: 200 OK (TradeResponse)
    end
