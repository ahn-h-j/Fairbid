<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FairBid - 호구 없는 경매</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <!-- 헤더 -->
    <header class="header">
        <div class="container header-content">
            <a href="/" class="logo">FairBid</a>

            <!-- 검색바 -->
            <form id="search-form" class="search-form" onsubmit="handleSearch(event)">
                <input
                    type="text"
                    id="search-input"
                    class="search-input"
                    placeholder="경매 상품 검색..."
                    aria-label="경매 상품 검색"
                >
                <button type="submit" class="btn btn-primary search-btn">검색</button>
            </form>

            <nav class="nav-menu">
                <a href="/create.html">경매 등록</a>
            </nav>
        </div>
    </header>

    <main class="container-wide">
        <!-- 필터 영역 -->
        <div class="filter-bar">
            <div class="filter-group">
                <label for="status-filter">상태</label>
                <select id="status-filter" onchange="handleFilterChange()">
                    <option value="">전체</option>
                    <option value="BIDDING">진행중</option>
                    <option value="ENDED">종료</option>
                    <option value="FAILED">유찰</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="sort-filter">정렬</label>
                <select id="sort-filter" onchange="handleFilterChange()">
                    <option value="createdAt,DESC">최신순</option>
                    <option value="currentPrice,ASC">낮은가격순</option>
                    <option value="currentPrice,DESC">높은가격순</option>
                </select>
            </div>

            <!-- 현재 검색어 표시 -->
            <div id="search-tag" class="search-tag" style="display: none;">
                <span id="search-keyword"></span>
                <button type="button" onclick="clearSearch()" class="clear-btn" aria-label="검색어 지우기">&times;</button>
            </div>
        </div>

        <!-- 로딩 상태 -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>경매 목록을 불러오는 중...</p>
        </div>

        <!-- 에러 상태 -->
        <div id="error" class="alert alert-error" style="display: none;"></div>

        <!-- 빈 결과 -->
        <div id="empty" class="empty-state" style="display: none;">
            <p>검색 결과가 없습니다.</p>
        </div>

        <!-- 경매 목록 그리드 -->
        <div id="auction-grid" class="auction-grid" style="display: none;"></div>

        <!-- 페이지네이션 -->
        <div id="pagination" class="pagination" style="display: none;"></div>
    </main>

    <script src="/js/api.js"></script>
    <script>
        // 현재 조회 파라미터
        let currentParams = {
            keyword: '',
            status: '',
            sort: 'createdAt,DESC',
            page: 0,
            size: 20
        };

        // 페이지 로드 시 실행
        document.addEventListener('DOMContentLoaded', function() {
            // URL에서 파라미터 읽기
            loadParamsFromUrl();
            // 경매 목록 로드
            loadAuctions();
        });

        // 브라우저 뒤로가기/앞으로가기 처리
        window.addEventListener('popstate', function() {
            loadParamsFromUrl();
            loadAuctions();
        });

        // URL에서 파라미터 읽기
        function loadParamsFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);

            currentParams.keyword = urlParams.get('keyword') || '';
            currentParams.status = urlParams.get('status') || '';
            currentParams.sort = urlParams.get('sort') || 'createdAt,DESC';
            currentParams.page = parseInt(urlParams.get('page')) || 0;

            // UI 동기화
            document.getElementById('search-input').value = currentParams.keyword;
            document.getElementById('status-filter').value = currentParams.status;
            document.getElementById('sort-filter').value = currentParams.sort;

            // 검색 태그 표시
            updateSearchTag();
        }

        // URL 업데이트 (새로고침 없이)
        function updateUrl() {
            const params = new URLSearchParams();

            if (currentParams.keyword) params.set('keyword', currentParams.keyword);
            if (currentParams.status) params.set('status', currentParams.status);
            if (currentParams.sort !== 'createdAt,DESC') params.set('sort', currentParams.sort);
            if (currentParams.page > 0) params.set('page', currentParams.page);

            const newUrl = params.toString() ? `?${params.toString()}` : '/';
            history.pushState(null, '', newUrl);
        }

        // 검색 태그 업데이트
        function updateSearchTag() {
            const tagEl = document.getElementById('search-tag');
            const keywordEl = document.getElementById('search-keyword');

            if (currentParams.keyword) {
                keywordEl.textContent = `"${currentParams.keyword}"`;
                tagEl.style.display = 'flex';
            } else {
                tagEl.style.display = 'none';
            }
        }

        // 검색 처리
        function handleSearch(event) {
            event.preventDefault();
            const keyword = document.getElementById('search-input').value.trim();
            currentParams.keyword = keyword;
            currentParams.page = 0;
            updateUrl();
            updateSearchTag();
            loadAuctions();
        }

        // 검색 초기화
        function clearSearch() {
            currentParams.keyword = '';
            currentParams.page = 0;
            document.getElementById('search-input').value = '';
            updateUrl();
            updateSearchTag();
            loadAuctions();
        }

        // 필터 변경 처리
        function handleFilterChange() {
            currentParams.status = document.getElementById('status-filter').value;
            currentParams.sort = document.getElementById('sort-filter').value;
            currentParams.page = 0;
            updateUrl();
            loadAuctions();
        }

        // 페이지 변경 처리
        function goToPage(page) {
            currentParams.page = page;
            updateUrl();
            loadAuctions();
            // 스크롤 상단으로
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // 경매 목록 로드
        async function loadAuctions() {
            showLoading();

            try {
                const response = await getAuctionList(currentParams);
                renderAuctions(response);
            } catch (error) {
                showError(error.message);
            }
        }

        // 경매 목록 렌더링
        function renderAuctions(pageData) {
            hideLoading();

            const gridEl = document.getElementById('auction-grid');
            const emptyEl = document.getElementById('empty');
            const paginationEl = document.getElementById('pagination');

            // 빈 결과 처리
            if (!pageData.content || pageData.content.length === 0) {
                gridEl.style.display = 'none';
                paginationEl.style.display = 'none';
                emptyEl.style.display = 'block';
                return;
            }

            emptyEl.style.display = 'none';
            gridEl.style.display = 'grid';

            // 경매 카드 렌더링
            gridEl.innerHTML = pageData.content.map(auction => createAuctionCard(auction)).join('');

            // 페이지네이션 렌더링
            renderPagination(pageData);
        }

        // 경매 카드 생성
        function createAuctionCard(auction) {
            const statusClass = getStatusClass(auction.status);
            const statusText = formatStatus(auction.status);

            return `
                <a href="/detail.html?id=${auction.id}" class="auction-card">
                    <div class="card-image">
                        ${auction.thumbnailUrl
                            ? `<img src="${auction.thumbnailUrl}" alt="${escapeHtml(auction.title)}">`
                            : '<div class="no-image">이미지 없음</div>'
                        }
                        <span class="status-badge ${statusClass}">${statusText}</span>
                    </div>
                    <div class="card-body">
                        <h3 class="card-title">${escapeHtml(auction.title)}</h3>
                        <div class="card-price">${formatPrice(auction.currentPrice)}</div>
                        <div class="card-meta">
                            <span>입찰 ${auction.totalBidCount}회</span>
                        </div>
                    </div>
                </a>
            `;
        }

        // 페이지네이션 렌더링
        function renderPagination(pageData) {
            const paginationEl = document.getElementById('pagination');

            if (pageData.totalPages <= 1) {
                paginationEl.style.display = 'none';
                return;
            }

            paginationEl.style.display = 'flex';

            const currentPage = pageData.number;
            const totalPages = pageData.totalPages;

            // 표시할 페이지 범위 계산
            let startPage = Math.max(0, currentPage - 2);
            let endPage = Math.min(totalPages - 1, currentPage + 2);

            // 최소 5개 페이지 표시
            if (endPage - startPage < 4) {
                if (startPage === 0) {
                    endPage = Math.min(4, totalPages - 1);
                } else {
                    startPage = Math.max(0, totalPages - 5);
                }
            }

            let html = '';

            // 이전 버튼
            html += `<button class="page-btn" ${currentPage === 0 ? 'disabled' : ''} onclick="goToPage(${currentPage - 1})" aria-label="이전 페이지">&lt;</button>`;

            // 첫 페이지
            if (startPage > 0) {
                html += `<button class="page-btn" onclick="goToPage(0)">1</button>`;
                if (startPage > 1) {
                    html += `<span class="page-ellipsis">...</span>`;
                }
            }

            // 페이지 번호들
            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i + 1}</button>`;
            }

            // 마지막 페이지
            if (endPage < totalPages - 1) {
                if (endPage < totalPages - 2) {
                    html += `<span class="page-ellipsis">...</span>`;
                }
                html += `<button class="page-btn" onclick="goToPage(${totalPages - 1})">${totalPages}</button>`;
            }

            // 다음 버튼
            html += `<button class="page-btn" ${currentPage === totalPages - 1 ? 'disabled' : ''} onclick="goToPage(${currentPage + 1})" aria-label="다음 페이지">&gt;</button>`;

            paginationEl.innerHTML = html;
        }

        // 로딩 표시
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            document.getElementById('empty').style.display = 'none';
            document.getElementById('auction-grid').style.display = 'none';
            document.getElementById('pagination').style.display = 'none';
        }

        // 로딩 숨김
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        // 에러 표시
        function showError(message) {
            hideLoading();
            const errorEl = document.getElementById('error');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }

        // 상태 클래스
        function getStatusClass(status) {
            const map = {
                'BIDDING': 'status-bidding',
                'INSTANT_BUY_PENDING': 'status-instant',
                'ENDED': 'status-ended',
                'FAILED': 'status-failed',
                'CANCELLED': 'status-cancelled'
            };
            return map[status] || 'status-ended';
        }

        // 상태 텍스트
        function formatStatus(status) {
            const map = {
                'BIDDING': '진행중',
                'INSTANT_BUY_PENDING': '즉시구매 대기',
                'ENDED': '종료',
                'FAILED': '유찰',
                'CANCELLED': '취소됨'
            };
            return map[status] || status;
        }

        // HTML 이스케이프 (XSS 방지)
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
