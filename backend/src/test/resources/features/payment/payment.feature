# language: ko
기능: 결제 처리
  낙찰자가 결제 기한 내에 결제를 진행하고, 기한 초과 시 노쇼 처리가 수행된다.
  2순위 낙찰자가 있고 90% 이상인 경우 자동 승계가 진행된다.

  배경:
    조건 서버가 실행중이다

  # =============================================================================
  # 정상 결제 시나리오
  # =============================================================================

  시나리오: 1순위 낙찰자가 기한 내 결제 성공
    # 경매 등록
    조건 판매자가 아래와 같은 경매 정보를 입력한다
      | title           | 맥북 프로 16인치              |
      | description     | M3 Pro, 상태 좋음             |
      | category        | ELECTRONICS                |
      | startPrice      | 1000000                    |
      | instantBuyPrice | 2000000                    |
      | duration        | HOURS_24                   |
    그리고 경매 등록을 요청한다
    그리고 응답 상태 코드는 201이다

    # 입찰 및 낙찰
    그리고 구매자가 원터치 입찰을 요청한다
    그리고 응답 상태 코드는 201이다
    만약 경매 종료 처리를 실행한다
    그러면 경매 상태가 "ENDED"로 변경된다
    그리고 1순위 낙찰 정보가 생성된다
    그리고 Transaction이 생성되고 상태가 "AWAITING_PAYMENT"이다

    # 결제 성공
    만약 낙찰자가 결제를 요청한다
    그러면 응답 상태 코드는 200이다
    그리고 Transaction 상태가 "PAID"로 변경된다
    그리고 Winning 상태가 "PAID"로 변경된다

  # =============================================================================
  # 결제 실패 시나리오
  # =============================================================================

  시나리오: 결제 기한 만료 후 결제 시도
    # 경매 등록 및 낙찰
    조건 판매자가 아래와 같은 경매 정보를 입력한다
      | title           | 아이패드 프로                  |
      | description     | 12.9인치 M2                  |
      | category        | ELECTRONICS                |
      | startPrice      | 800000                     |
      | instantBuyPrice | 1200000                    |
      | duration        | HOURS_24                   |
    그리고 경매 등록을 요청한다
    그리고 응답 상태 코드는 201이다
    그리고 구매자가 원터치 입찰을 요청한다
    그리고 응답 상태 코드는 201이다
    만약 경매 종료 처리를 실행한다
    그러면 경매 상태가 "ENDED"로 변경된다
    그리고 Transaction이 생성되고 상태가 "AWAITING_PAYMENT"이다

    # 결제 기한 만료 후 시도
    조건 결제 기한이 만료됨
    만약 낙찰자가 결제를 요청한다
    그러면 응답 상태 코드는 400이다
    그리고 응답 본문의 "errorCode" 값은 "PAYMENT_EXPIRED"이다

  시나리오: 이미 결제 완료된 거래에 재결제 시도
    # 경매 등록 및 낙찰
    조건 판매자가 아래와 같은 경매 정보를 입력한다
      | title           | 갤럭시 S24                   |
      | description     | 256GB 언락                   |
      | category        | ELECTRONICS                |
      | startPrice      | 700000                     |
      | instantBuyPrice | 1100000                    |
      | duration        | HOURS_24                   |
    그리고 경매 등록을 요청한다
    그리고 응답 상태 코드는 201이다
    그리고 구매자가 원터치 입찰을 요청한다
    그리고 응답 상태 코드는 201이다
    만약 경매 종료 처리를 실행한다
    그러면 경매 상태가 "ENDED"로 변경된다

    # 첫 결제 성공
    만약 낙찰자가 결제를 요청한다
    그러면 응답 상태 코드는 200이다

    # 재결제 시도
    만약 낙찰자가 결제를 요청한다
    그러면 응답 상태 코드는 400이다
    그리고 응답 본문의 "errorCode" 값은 "ALREADY_PAID"이다

  시나리오: 본인 거래가 아닌 경우 결제 시도
    # 경매 등록 및 낙찰
    조건 판매자가 아래와 같은 경매 정보를 입력한다
      | title           | 에어팟 프로                   |
      | description     | 2세대, 미개봉                 |
      | category        | ELECTRONICS                |
      | startPrice      | 200000                     |
      | instantBuyPrice | 300000                     |
      | duration        | HOURS_24                   |
    그리고 경매 등록을 요청한다
    그리고 응답 상태 코드는 201이다
    그리고 구매자가 원터치 입찰을 요청한다
    그리고 응답 상태 코드는 201이다
    만약 경매 종료 처리를 실행한다
    그러면 경매 상태가 "ENDED"로 변경된다

    # 다른 사용자가 결제 시도
    만약 다른 사용자가 결제를 요청한다
    그러면 응답 상태 코드는 403이다
    그리고 응답 본문의 "errorCode" 값은 "NOT_TRANSACTION_BUYER"이다

  # =============================================================================
  # 2순위 승계 시나리오
  # =============================================================================

  시나리오: 1순위 노쇼 후 2순위 승계 및 결제
    # 경매 등록
    조건 판매자가 아래와 같은 경매 정보를 입력한다
      | title           | LG 그램                      |
      | description     | 17인치, 최신형                |
      | category        | ELECTRONICS                |
      | startPrice      | 1000000                    |
      | instantBuyPrice | 1800000                    |
      | duration        | HOURS_24                   |
    그리고 경매 등록을 요청한다
    그리고 응답 상태 코드는 201이다

    # 2명 입찰 (2순위가 1순위의 90% 이상)
    그리고 구매자A가 1100000원으로 직접 입찰을 요청한다
    그리고 응답 상태 코드는 201이다
    그리고 구매자B가 1200000원으로 직접 입찰을 요청한다
    그리고 응답 상태 코드는 201이다

    # 경매 종료
    만약 경매 종료 처리를 실행한다
    그러면 경매 상태가 "ENDED"로 변경된다
    그리고 1순위 낙찰 정보가 생성된다
    그리고 2순위 낙찰 후보 정보가 생성된다
    그리고 Transaction이 생성되고 구매자가 1순위이다

    # 1순위 노쇼 처리
    조건 1순위 결제 기한이 만료됨
    만약 노쇼 처리가 실행됨
    그러면 1순위 Winning 상태가 "NO_SHOW"이다
    그리고 2순위에게 결제 권한이 승계됨
    그리고 Transaction의 구매자가 2순위로 변경됨

    # 2순위 결제 성공
    만약 2순위가 결제를 요청한다
    그러면 응답 상태 코드는 200이다
    그리고 Transaction 상태가 "PAID"로 변경된다
    그리고 2순위 Winning 상태가 "PAID"이다

  시나리오: 2순위가 90% 미만인 경우 유찰 처리
    # 경매 등록
    조건 판매자가 아래와 같은 경매 정보를 입력한다
      | title           | 삼성 오디세이                  |
      | description     | 게이밍 모니터 32인치            |
      | category        | ELECTRONICS                |
      | startPrice      | 500000                     |
      | instantBuyPrice | 900000                     |
      | duration        | HOURS_24                   |
    그리고 경매 등록을 요청한다
    그리고 응답 상태 코드는 201이다

    # 2명 입찰 (2순위가 1순위의 90% 미만: 550000 < 700000 * 0.9 = 630000)
    그리고 구매자A가 550000원으로 직접 입찰을 요청한다
    그리고 응답 상태 코드는 201이다
    그리고 구매자B가 700000원으로 직접 입찰을 요청한다
    그리고 응답 상태 코드는 201이다

    # 경매 종료
    만약 경매 종료 처리를 실행한다
    그러면 경매 상태가 "ENDED"로 변경된다

    # 1순위 노쇼 → 2순위 90% 미만이므로 유찰
    조건 1순위 결제 기한이 만료됨
    만약 노쇼 처리가 실행됨
    그러면 1순위 Winning 상태가 "NO_SHOW"이다
    그리고 경매 상태가 "FAILED"로 변경된다
    그리고 Transaction 상태가 "CANCELLED"로 변경된다
