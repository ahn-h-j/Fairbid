name: CD

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            cd ~/Fairbid
            git pull origin main
            docker compose up --build -d

            # 헬스 체크 (백엔드 API)
            echo "Waiting for backend to be ready..."
            for i in {1..30}; do
              if curl -sf http://localhost:8080/actuator/health > /dev/null 2>&1; then
                echo "Backend is healthy!"
                exit 0
              fi
              echo "Attempt $i/30: Backend not ready yet..."
              sleep 5
            done
            echo "Backend health check failed!"
            exit 1
